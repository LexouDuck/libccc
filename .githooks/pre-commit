#!/bin/sh -e

#! utility variables for terminal colored output
ansi_esc() { printf "\033[""$@""m" ; }
IO_RESET="`   ansi_esc 0`"
IO_RED="`     ansi_esc 31`"
IO_GREEN="`   ansi_esc 32`"
IO_YELLOW="`  ansi_esc 33`"
IO_BLUE="`    ansi_esc 34`"
IO_MAGENTA="` ansi_esc 35`"
IO_CYAN="`    ansi_esc 36`"



#! The filepath of the version file
VERSIONFILE=VERSION

#! List of files with changes in this commit
CHANGED="` git diff --cached --name-only `"
printf "Files changed:$IO_CYAN\n$CHANGED\n$IO_RESET"

#! List of important files (which, when changed, should update the version number)
SOURCES=""
SOURCES="$SOURCES ` make help-makefiles | cut -d' ' -f 1 `"
SOURCES="$SOURCES ` make show-lists `"



match=false
for i in $CHANGED
do
	if printf "$SOURCES" | grep -q "./$i"
	then
		match=true
		break
	fi
done

if $match
then
	printf "Detected changes to important source files.\n"
	if printf "$CHANGED" | grep -q "$VERSIONFILE"
	then
		printf "Project version file '$VERSIONFILE' has already been updated.\n"
	else
		make version-patch
		git add $VERSIONFILE
	fi
fi

exit 0
